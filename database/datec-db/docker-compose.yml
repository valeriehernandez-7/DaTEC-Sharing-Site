# DaTEC Configuration
# MongoDB + Redis : Docker Multi-node | Neo4j + CouchDB : Local

services:
  # ================================================
  # MongoDB Replica Set (Multi-node) https://hub.docker.com/r/mongodb/mongodb-community-server
  # https://hub.docker.com/layers/mongodb/mongodb-community-server/8.0-ubi9/images/sha256-ff7e54273c0d68143396ea35cb03c6dec9e9c483b07fef2c3a702738e348d116
  # ================================================
  
  mongo-primary:
    image: mongo:8.0
    container_name: datec-mongo-primary
    restart: unless-stopped
    hostname: mongo-primary
    ports:
      - "27017:27017"
    command: >
      mongod --replSet datecRS 
        --bind_ip_all 
        --wiredTigerCacheSizeGB 0.5
    volumes:
      - mongo_primary_data:/data/db
      - ./scripts:/scripts:ro
    deploy:
      resources:
        limits:
          memory: 1.2G
        reservations:
          memory: 256M
    networks:
      - datec-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  mongo-secondary:
    image: mongo:8.0
    container_name: datec-mongo-secondary
    restart: unless-stopped
    hostname: mongo-secondary
    ports:
      - "27018:27017"
    command: >
      mongod --replSet datecRS 
        --bind_ip_all 
        --wiredTigerCacheSizeGB 0.3
    volumes:
      - mongo_secondary_data:/data/db
      - ./scripts:/scripts:ro
    deploy:
      resources:
        limits:
          memory: 800M
        reservations:
          memory: 128M
    depends_on:
      - mongo-primary
    networks:
      - datec-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ================================================
  # Redis Primary-Replica (Multi-node) https://hub.docker.com/_/redis
  # https://hub.docker.com/layers/library/redis/8-alpine/images/sha256-fc785a6b2936ec73d0c1c7dc81fb72383e0ce5d392d1c6b20dbafa68f0ff0572
  # ================================================
  
  redis-primary:
    image: redis:8-alpine
    container_name: datec-redis-primary
    restart: unless-stopped
    hostname: redis-primary
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --maxmemory 400mb 
      --maxmemory-policy allkeys-lru 
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis_primary_data:/data
      - ./scripts:/scripts:ro
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 64M
    networks:
      - datec-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  redis-replica:
    image: redis:8-alpine
    container_name: datec-redis-replica
    restart: unless-stopped
    hostname: redis-replica
    ports:
      - "6380:6379"
    command: >
      redis-server 
      --replicaof redis-primary 6379
      --maxmemory 200mb 
      --maxmemory-policy allkeys-lru
      --replica-read-only yes
    volumes:
      - redis_replica_data:/data
      - ./scripts:/scripts:ro
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 32M
    depends_on:
      - redis-primary
    networks:
      - datec-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ================================================
  # MongoDB Replica Set Configurator
  # ================================================
  
  mongo-setup:
    image: mongo:8.0
    container_name: datec-mongo-setup
    depends_on:
      mongo-primary:
        condition: service_healthy
      mongo-secondary:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts:ro
    command: >
      bash -c "
        echo 'Waiting for MongoDB nodes...' &&
        sleep 30 &&
        echo 'Configuring Replica Set...' &&
        mongosh --host mongo-primary:27017 /scripts/setup-mongo.js &&
        echo 'MongoDB setup complete!'
      "
    networks:
      - datec-network
    restart: "no"

  # ================================================
  # Redis Replica Set Configurator
  # ================================================

  redis-setup:
    image: node:18-alpine
    container_name: datec-redis-setup
    depends_on:
      redis-primary:
        condition: service_healthy
      redis-replica:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
    working_dir: /scripts
    command: >
      sh -c "
        echo 'Installing Redis client...' &&
        npm install redis --no-save &&
        echo 'Configuring Redis...' &&
        node setup-redis.js
      "
    networks:
      - datec-network
    restart: "no"

# ================================================
# Persistent Volumes
# C:\ProgramData\Docker\volumes\
# ================================================

volumes:
  mongo_primary_data:
  mongo_secondary_data:
  redis_primary_data:
  redis_replica_data:

# ================================================
# Internal Network
# ================================================

networks:
  datec-network:
    driver: bridge